<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Research Map — Angelika Manhart</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <style>
    :root {
      --ink:      #0a1f44;
      --mid:      #2a4a6b;
      --muted:    #5b95b8;
      --accent:   #0d3b7a;
      --accent2:  #1a6fa8;
      --pale:     #ddeaf3;
      --white:    #ffffff;
      --bg:       #f0f6fa;
      --border:   #c8dde8;
      --serif:    'DM Serif Display', Georgia, serif;
      --sans:     'DM Sans', system-ui, sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--sans); background: var(--white); color: var(--ink); font-size: 17px; line-height: 1.72; }

    /* NAV */
    nav {
      position: sticky; top: 0; z-index: 100;
      background: rgba(224,237,247,0.92); backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 5vw; height: 62px;
    }
    .nav-name { font-family: var(--serif); font-size: 1.05rem; color: var(--ink); text-decoration: none; display: flex; align-items: center; gap: 0.5rem; }
    .nav-portrait { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; object-position: center 20%; border: 2px solid var(--border); }
    .nav-links { display: flex; gap: 2rem; list-style: none; }
    .nav-links a { font-size: 0.82rem; font-weight: 600; letter-spacing: 0.07em; text-transform: uppercase; color: var(--mid); text-decoration: none; transition: color 0.2s; }
    .nav-links a:hover { color: var(--accent); }
    .hamburger { display: none; }

    .container { max-width: 1200px; margin: 0 auto; padding: 0 5vw; }

    .page-header { padding: 3rem 0 2rem; }
    .section-label { font-size: 0.73rem; font-weight: 700; letter-spacing: 0.18em; text-transform: uppercase; color: var(--accent2); margin-bottom: 0.5rem; }
    .section-title { font-family: var(--serif); font-size: clamp(1.7rem, 2.6vw, 2.3rem); color: var(--ink); margin-bottom: 0.9rem; }
    .section-intro { max-width: 720px; color: var(--mid); font-weight: 300; font-size: 1.05rem; line-height: 1.8; }

    /* MAP CONTAINER */
    #map-container {
      position: relative;
      width: 100%;
      height: 580px;
      background: var(--white);
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(13,59,122,0.08);
      margin: 1.5rem 0;
      overflow: hidden;
    }
    #research-map { width: 100%; height: 100%; display: block; }

    /* THEME NODE (foreignObject hub-card) */
    .hub-card-node {
      width: 160px;
      height: 160px;
      border-radius: 50%;
      border: 3px solid var(--accent2);
      background: rgba(255,255,255,0.94);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 0.6rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 6px 24px rgba(13,59,122,0.1);
      overflow: hidden;
      position: relative;
    }
    .hub-card-node::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, var(--pale) 0%, transparent 100%);
      opacity: 0;
      transition: opacity 0.3s;
      border-radius: 50%;
    }
    .hub-card-node:hover::before { opacity: 1; }
    .hub-card-node:hover {
      border-width: 4px;
      box-shadow: 0 15px 50px rgba(13,59,122,0.18);
      transform: scale(1.06);
    }
    .hub-card-node.active {
      border-width: 4px;
      box-shadow: 0 0 0 5px rgba(26,111,168,0.2), 0 10px 40px rgba(13,59,122,0.18);
    }
    /* foreignObject wrapper: oversized to avoid clipping shadows */
    .theme-fo {
      overflow: visible;
      pointer-events: none;
    }
    .theme-fo-inner {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .theme-fo-inner .hub-card-node {
      pointer-events: auto;
    }
    .hub-image-node {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--pale);
      overflow: hidden;
      border: 2px solid white;
      box-shadow: 0 2px 8px rgba(13,59,122,0.1);
      margin-bottom: 0.3rem;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
      transition: transform 0.3s;
    }
    .hub-card-node:hover .hub-image-node {
      transform: rotate(5deg) scale(1.08);
    }
    .hub-image-node img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .hub-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .hub-card-node h3 {
      font-family: var(--serif);
      font-size: 0.85rem;
      color: var(--ink);
      line-height: 1.2;
      position: relative;
      z-index: 1;
      margin-bottom: 0.15rem;
    }
    .hub-card-node p {
      font-size: 0.68rem;
      color: var(--muted);
      font-weight: 300;
      position: relative;
      z-index: 1;
      line-height: 1.3;
    }

    /* LINKS */
    .map-link {
      fill: none;
      stroke-width: 1.5;
      stroke-opacity: 0.25;
      transition: stroke-opacity 0.3s, stroke-width 0.3s;
    }
    .map-link.highlighted {
      stroke-opacity: 0.7;
      stroke-width: 2.5;
    }
    .map-link.dimmed { stroke-opacity: 0.05; }

    /* PUB NODES */
    .pub-sq { cursor: pointer; transition: all 0.2s; }
    .pub-sq:hover { filter: drop-shadow(0 2px 6px rgba(26,111,168,0.3)); }
    .pub-node-g.dimmed rect { opacity: 0.12; }
    .pub-node-g.dimmed text { opacity: 0.08; }
    .theme-node-g.dimmed { opacity: 0.2; }

    /* TOOLTIP */
    #tooltip {
      position: fixed;
      background: var(--ink);
      color: white;
      padding: 0.5rem 0.8rem;
      border-radius: 6px;
      font-size: 0.78rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      max-width: 300px;
      line-height: 1.5;
      z-index: 300;
    }
    #tooltip .tt-name { font-weight: 700; font-size: 0.85rem; margin-bottom: 0.15rem; }
    #tooltip .tt-meta { opacity: 0.7; font-size: 0.75rem; }

    /* LEGEND */
    .map-legend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: -0.6rem;
    }
    .map-legend-title { font-weight: 600; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
    .map-legend-item { display: flex; align-items: center; gap: 0.35rem; }
    .legend-sq { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }

    /* THEME DETAIL PANEL (below SVG) */
    #theme-detail-panel {
      max-width: 1200px;
      margin: 0 auto;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.5s ease, opacity 0.4s ease, margin 0.4s ease, padding 0.4s ease;
      padding: 0 2rem;
      scroll-margin-top: 80px;
    }
    #theme-detail-panel.open {
      opacity: 1;
      padding: 2rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--white);
      margin-top: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(13,59,122,0.08);
    }
    .theme-detail-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
    .theme-detail-header { display: flex; align-items: center; gap: 1.2rem; }
    .theme-detail-icon {
      width: 56px; height: 56px; border-radius: 50%;
      border: 3px solid var(--accent2);
      overflow: hidden; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      background: var(--pale);
    }
    .theme-detail-icon img { width: 100%; height: 100%; object-fit: cover; }
    .theme-detail-title { font-family: var(--serif); font-size: 1.4rem; color: var(--ink); margin-bottom: 0.15rem; }
    .theme-detail-subtitle { font-size: 0.88rem; color: var(--muted); font-weight: 300; }
    .close-detail-btn {
      width: 36px; height: 36px; border-radius: 50%;
      border: 1px solid var(--border); background: var(--white);
      color: var(--mid); font-size: 1.2rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .close-detail-btn:hover { border-color: var(--accent2); color: var(--accent2); }
    .theme-detail-desc { color: var(--mid); font-weight: 300; line-height: 1.75; margin-bottom: 2rem; font-size: 0.95rem; }
    .theme-detail-desc img { max-width: 100%; height: auto; border-radius: 8px; margin: 1rem 0; }
    .theme-detail-desc a { color: var(--accent2); text-decoration: none; font-weight: 500; }
    .theme-detail-desc a:hover { text-decoration: underline; }
    .theme-detail-desc .detail-banner { background: var(--bg); border-left: 4px solid var(--accent2); border-radius: 0 8px 8px 0; padding: 1.2rem 1.5rem; margin-bottom: 1.8rem; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 0.8rem; }
    .theme-detail-desc .detail-banner p { font-size: 1rem; font-weight: 400; color: var(--ink); margin: 0; }
    .theme-detail-desc .detail-banner .project-number { font-size: 0.8rem; color: var(--muted); font-weight: 500; letter-spacing: 0.03em; }
    .detail-link-btn { display: inline-block; font-size: 0.75rem; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; padding: 0.45rem 1rem; border: 1px solid var(--accent2); border-radius: 6px; color: var(--accent2); text-decoration: none !important; transition: all 0.2s; white-space: nowrap; }
    .detail-link-btn:hover { background: var(--accent2); color: var(--white) !important; }
    .theme-detail-desc h3 { font-family: var(--serif); font-size: 1.1rem; color: var(--ink); margin: 1.8rem 0 0.6rem; padding-bottom: 0.3rem; border-bottom: 2px solid var(--pale); }
    .theme-detail-desc h3:first-child { margin-top: 0; }
    .theme-detail-desc .detail-figure { margin: 1.2rem 0; text-align: center; }
    .theme-detail-desc .detail-figure img { width: 100%; max-width: 700px; margin: 0 auto; display: block; }
    .theme-detail-desc .detail-figure.small img { max-width: 280px; }
    .theme-detail-desc .detail-figure figcaption { font-size: 0.8rem; color: var(--muted); margin-top: 0.4rem; font-style: italic; }
    .theme-detail-desc .detail-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; align-items: start; margin: 1.2rem 0; }
    @media (max-width: 600px) { .theme-detail-desc .detail-row { grid-template-columns: 1fr; } }
    .theme-detail-desc h4 { font-family: var(--sans); font-size: 0.82rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent2); margin: 0 0 0.5rem; }
    .pub-list-heading { font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent2); margin-bottom: 1rem; }

    /* PUB-ITEM (from publications.html) */
    .pub-list { display: flex; flex-direction: column; gap: 1.1rem; }
    .pub-item { background: var(--white); border: 1px solid var(--border); border-left: 3px solid var(--accent2); padding: 1.4rem 1.6rem; border-radius: 0 8px 8px 0; display: grid; grid-template-columns: 64px 1fr auto; gap: 0.5rem 1.2rem; align-items: start; }
    .pub-thumb { width: 64px; height: 64px; border-radius: 6px; background: var(--pale); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
    .pub-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .pub-thumb svg { width: 28px; height: 28px; opacity: 0.35; }
    .pub-title-row { display: flex; align-items: baseline; gap: 0.6rem; flex-wrap: wrap; margin-bottom: 0.25rem; }
    .pub-title { font-family: var(--serif); font-size: 1rem; color: var(--ink); }
    .pub-tag { display: inline-block; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; padding: 0.15rem 0.55rem; border-radius: 4px; color: #fff; white-space: nowrap; vertical-align: middle; position: relative; top: -1px; }
    .pub-tag-data { background: #2e7d32; }
    .pub-tag-theorem { background: #c62828; }
    .pub-tag-other { background: #795548; }
    .pub-meta { font-size: 0.84rem; color: var(--muted); font-weight: 300; }
    .pub-meta strong { color: var(--mid); font-weight: 600; }
    .pub-year { font-size: 0.78rem; font-weight: 700; color: var(--accent2); letter-spacing: 0.06em; white-space: nowrap; padding-top: 0.2rem; }
    .pub-links { display: flex; gap: 0.5rem; margin-top: 0.65rem; flex-wrap: wrap; }
    .pub-link { font-size: 0.73rem; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; padding: 0.2rem 0.6rem; border: 1px solid var(--border); border-radius: 4px; color: var(--mid); text-decoration: none; transition: all 0.2s; }
    .pub-link:hover { border-color: var(--accent2); color: var(--accent2); }

    /* PUB MODAL */
    .pub-modal-overlay {
      position: fixed; inset: 0;
      background: rgba(10,31,68,0.4);
      backdrop-filter: blur(4px);
      z-index: 500;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none;
      transition: opacity 0.25s;
    }
    .pub-modal-overlay.open { opacity: 1; pointer-events: auto; }
    .pub-modal-card {
      background: var(--white);
      border-radius: 12px;
      max-width: 650px; width: 90%;
      padding: 2rem;
      box-shadow: 0 20px 60px rgba(13,59,122,0.2);
      position: relative;
      transform: translateY(20px);
      transition: transform 0.3s;
    }
    .pub-modal-overlay.open .pub-modal-card { transform: translateY(0); }
    .pub-modal-close {
      position: absolute; top: 1rem; right: 1rem;
      width: 32px; height: 32px; border-radius: 50%;
      border: 1px solid var(--border); background: var(--white);
      color: var(--mid); font-size: 1.1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .pub-modal-close:hover { border-color: var(--accent2); color: var(--accent2); }

    footer { text-align: center; padding: 1.8rem 5vw; font-size: 0.78rem; color: var(--muted); border-top: 1px solid var(--border); }

    @media (max-width: 800px) {
      .nav-links {
        display: none;
        flex-direction: column;
        position: absolute;
        top: 62px; left: 0; right: 0;
        background: rgba(224,237,247,0.97);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border);
        padding: 1rem 5vw;
        gap: 0.5rem;
      }
      .nav-links.open { display: flex; }
      .hamburger {
        display: flex; align-items: center; justify-content: center;
        background: none; border: none; cursor: pointer;
        width: 38px; height: 38px; padding: 0;
      }
      .hamburger svg { width: 22px; height: 22px; stroke: var(--ink); stroke-width: 2; stroke-linecap: round; }
      #map-container { height: 400px; }
      .pub-item { grid-template-columns: 48px 1fr; }
      .pub-thumb { width: 48px; height: 48px; }
      .pub-year { grid-column: 1 / -1; }
    }
  </style>
</head>
<body>

  <nav>
    <a class="nav-name" href="index.html"><img class="nav-portrait" src="images/portrait_me.jpg" alt=""/>Angelika Manhart</a>
    <ul class="nav-links">
      <li><a href="index.html#about">About</a></li>
      <li><a href="research.html">Research</a></li>
      <li><a href="publications.html">Publications</a></li>
      <li><a href="index.html#team">Team</a></li>
      <li style="display:none;"><a href="teaching.html">Teaching</a></li>
      <li><a href="outreach.html">Outreach & Art</a></li>
      <li><a href="cv.html">CV</a></li>
      <li><a href="index.html#contact">Contact</a></li>
    </ul>
    <button class="hamburger" aria-label="Menu" onclick="document.querySelector('.nav-links').classList.toggle('open')">
      <svg viewBox="0 0 24 24" fill="none"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
  </nav>
  <script>document.querySelector('.nav-links').addEventListener('click',function(e){if(e.target.tagName==='A')this.classList.remove('open');})</script>

<div class="container">
  <div class="page-header">
    <p class="section-label">Focus Areas</p>
    <h2 class="section-title">Research Map</h2>
    <p class="section-intro">Explore my research themes and their connected publications. Click a theme circle to see details and related papers, or click a publication square to view the paper.</p>
    <a class="detail-link-btn" href="publications.html" style="margin-top: 1rem; display: inline-block;">See all publications &rarr;</a>
  </div>

  <div class="map-legend">
    <div class="map-legend-title">Publications:</div>
    <div class="map-legend-item"><div class="legend-sq" style="background:#fecaca; border:1.5px solid #c62828;"></div> Contains proofs</div>
    <div class="map-legend-item"><div class="legend-sq" style="background:#a7f3d0; border:1.5px solid #059669;"></div> Contains data</div>
    <div class="map-legend-item"><div class="legend-sq" style="background:#e5e7eb; border:1.5px solid #6b7280;"></div> Other</div>
  </div>
  <div id="map-container">
    <svg id="research-map"></svg>
  </div>

  <div id="theme-detail-panel">
    <div class="theme-detail-top">
      <div class="theme-detail-header">
        <div class="theme-detail-icon" id="detailIcon"></div>
        <div>
          <h2 class="theme-detail-title" id="detailTitle"></h2>
          <p class="theme-detail-subtitle" id="detailSubtitle"></p>
        </div>
      </div>
      <button class="close-detail-btn" onclick="closeThemeDetail()">&times;</button>
    </div>
    <p class="theme-detail-desc" id="detailDesc"></p>
    <div class="pub-list-heading" id="detailPubCount"></div>
    <div class="pub-list" id="detailPubList"></div>
  </div>
</div>

<div class="pub-modal-overlay" id="pubModalOverlay">
  <div class="pub-modal-card">
    <button class="pub-modal-close" onclick="closePubModal()">&times;</button>
    <div id="pubModalContent"></div>
  </div>
</div>

<div id="tooltip"></div>

<footer>&copy; 2025 Manhart A &middot; University of Vienna &middot; Faculty of Mathematics</footer>

<script>
// ── DATA ──────────────────────────────────────────────────────────────────────
var themes = [
  {
    id: 'collective',
    name: 'Collective Dynamics',
    subtitle: 'Alignment & Pattern Formation',
    description: 'Collective Dynamics studies how complex patterns arise from individual interactions. The research projects here range from studying specific systems & organisms, to investigating how environmental interactions influence patterns, to investigating alignment mechanisms.',
    color: '#2563eb',
    thumb: 'images/research_thumbs/collective_thumb.png'
  },
  {
    id: 'cytoskeleton',
    name: 'Cytoskeleton',
    subtitle: 'Cell Migration & Fibre Dynamics',
    description: 'A cell\u2019s cytoskeleton allows cells to perform various tasks, such as cell migration or position its cell organelles, such as nuclei. In this research we model the cytoskeleton using differential equations and study its properties and function.',
    color: '#059669',
    thumb: 'images/research_thumbs/cytoskeleton_thumb.png'
  },
  {
    id: 'myxobacteria',
    name: 'Myxobacteria',
    subtitle: 'Coordination & Waves',
    description: 'Myxobacteria are soil-living bacteria that can glide on 2D surfaces using different movement mechanisms. In different settings they show fascinating collective pattern which include clustering and wave formation. We used collision operators to describe bacteria interactions and derived continuum equations. Studying these revealed criteria and mechanisms for the appearance of the fascinating counter-propagating waves.',
    color: '#d97706',
    thumb: 'images/research_thumbs/myxo_thumb.png'
  },
  {
    id: 'organells',
    name: 'Cell Organelles',
    subtitle: 'Nuclear Positioning & Scaling',
    description: 'The nucleus is a cell\u2019s central organ. Muscle cells can contain 10s\u2013100s of nuclei. Their position and size is important for muscle function & health. Using data & mathematical modelling, we investigate positioning and size scaling mechanism in single and multi-nucleated cells.',
    color: '#7c3aed',
    thumb: 'images/research_thumbs/organelle_thumb.png'
  },
  {
    id: 'mohecce',
    name: 'MOHECCE',
    subtitle: 'Heterogeneous Cell Clusters in Cancer',
    description: 'Modelling Heterogeneous Cell Clusters and their Environment \u2014 funded by the Austrian Science Fund (FWF) as part of their ASTRA funding scheme (2026\u20132031).',
    richDescription: '<div class="detail-banner"><div><p>Modelling Heterogeneous Cell Clusters and their Environment (MOHECCE)</p><span class="project-number">FWF ASTRA 2026\u20132031 \u00b7 Project AST1156424</span></div><a class="detail-link-btn" href="https://www.fwf.ac.at/entdecken/auszeichnungen/fwf-astra-preise/2025" target="_blank">FWF ASTRA Award</a></div>' +
      '<h3>Background</h3>' +
      '<p>Cancer cell clusters are more successful at metastasizing than single cells. This interdisciplinary project combines mathematical modeling and simulation with experiments to understand collective cell migration. We investigate how cell properties, their environment, and cell\u2013cell communication shape collective behavior.</p>' +
      '<figure class="detail-figure"><img src="images/MOHECCE/fig_bio_overview2.png" alt="From cell signalling to individual behaviour to collective dynamics"/><figcaption>From cell signalling to individual cell behaviour to collective cell dynamics</figcaption></figure>' +
      '<h3>Guiding Questions</h3>' +
      '<p>How do cells self-organize into clusters, and what factors influence their formation? What advantages do clustered cells have compared to individual migrating cells? We focus on two key aspects: <em>cell state heterogeneity</em> and the <em>cluster environment</em>.</p>' +
      '<h3>Approach</h3>' +
      '<figure class="detail-figure"><img src="images/MOHECCE/fig_compare.png" alt="Models and data sources overview"/><figcaption>Combining mathematical models with experimental data sources</figcaption></figure>' +
      '<div class="detail-row">' +
        '<div><h4>Mathematical Methods</h4><p>Interacting particle models, differential equations (ODEs and PDEs), numerical simulations, and quantitative data analysis.</p>' +
        '</div>' +
        '<div><h4>Experimental Component</h4><p>Led by <a href="https://krebsforschung.meduniwien.ac.at/schwerpunkt/metasierung/juliane-winkler/" target="_blank">Juliane Winkler</a> at the Medical University of Vienna, examining how cell state and matrix conditions affect cell group properties and metastatic potential using breast cancer cell lines.</p></div>' +
      '</div>' +
      '<div style="display:flex; gap:1.5rem; justify-content:center; align-items:start; margin:1.2rem 0; flex-wrap:wrap;">' +
        '<figure class="detail-figure" style="flex:1; max-width:40%; min-width:200px;"><img src="images/MOHECCE/fig_math.png" alt="Mathematical methods"/></figure>' +
        '<figure class="detail-figure" style="flex:1; max-width:40%; min-width:200px;"><img src="images/MOHECCE/fig_exp.png" alt="Microscopy of cancer cells"/><figcaption>Breast cancer cells (microscopy)</figcaption></figure>' +
      '</div>',
    color: '#dc2626',
    thumb: 'images/research_thumbs/MOHECCE.png'
  },
  {
    id: 'other',
    name: 'Other',
    subtitle: 'Eye Development & More',
    description: 'Additional research on the development of the fruit fly eye and works related to past internships.',
    color: '#64748b',
    thumb: 'images/research_thumbs/other_thumb.png'
  }
];

var publications = [
  { year: 2025, title: "Integrins coordinate basal surface contraction and oriented cell growth to enable thickening of a curved epithelium", journal: "Current Biology", doi: "10.1016/j.cub.2025.05.048", themes: ['collective','other'], category: 'data', authors: 'Lancaster C, Manhart A, Pichaud F', thumbnail: 'publications/eye_development_thumb.png', pdfUrl: 'publications/eye_development.pdf' },
  { year: 2024, title: "A dynamical analysis of the alignment mechanism between two interacting cells", journal: "Bulletin of Mathematical Biology", doi: null, themes: ['collective'], category: 'theorem', authors: 'Leech V, Dalwadi MP, Manhart A', thumbnail: 'publications/cell_alignment_analytical_thumb.png', pdfUrl: 'publications/cell_alignment_analytical.pdf' },
  { year: 2024, title: "Derivation and simulation of a computational model of active cell populations: How overlap avoidance, deformability, cell-cell junctions and cytoskeletal forces affect alignment", journal: "PLOS Computational Biology", doi: "10.1371/journal.pcbi.1011879", themes: ['collective'], category: 'data', authors: 'Leech V, Kenny FN, Marcotti S, Shaw TJ, Stramer BM, Manhart A', thumbnail: 'publications/cell_alignment_computational_thumb.png', pdfUrl: 'publications/cell_alignment_computational.pdf' },
  { year: 2023, title: "Controlling periodic long-range signalling to drive a morphogenetic transition", journal: "eLife", doi: "10.7554/elife.83796", themes: ['collective'], category: 'data', authors: 'Ford HZ, Manhart A, Chubb JR', thumbnail: 'publications/periodic_long_range_thumb.png', pdfUrl: 'publications/periodic_long_range_signalling_dicty.pdf' },
  { year: 2023, title: "Autocrine IL-6 drives cell and extracellular matrix anisotropy in scar fibroblasts", journal: "Matrix Biology", doi: null, themes: ['collective','cytoskeleton'], category: 'data', authors: 'Kenny FN, Marcotti S, DeFreitas DB, Drudi EM, Leech V, Bell RE, Easton J, Diaz-de-la-Loza MdC, Fleck R, Allison L, Phillippeos C, Manhart A, Shaw TJ, Stramer BM', thumbnail: 'publications/cell_alignment_biology_thumb.png', pdfUrl: 'publications/cell_alignment_biology.pdf' },
  { year: 2022, title: "How environment affects active particle swarms: a case study", journal: "Royal Society Open Science", doi: "10.1098/rsos.220791", themes: ['collective'], category: 'theorem', authors: 'Degond P, Manhart A, Merino-Aceituno S, Peurichard D, Sala L', thumbnail: 'publications/environment_swarm_thumb.png', pdfUrl: 'publications/environment_particle_swarms.pdf' },
  { year: 2022, title: "Chaos in synthetic microbial communities", journal: "PLOS Computational Biology", doi: null, themes: ['collective'], category: 'theorem', authors: 'Karkaria BD, Rao C, Manhart A, Fedorec AJH, Barnes CP', thumbnail: 'publications/chaos_synthetic_communities_thumb.png', pdfUrl: 'publications/chaos_synthetic_communities.pdf' },
  { year: 2022, title: "Mathematical modeling accurately predicts the dynamics and scaling of nuclear growth in discrete cytoplasmic volumes", journal: "Journal of Theoretical Biology", doi: "10.1016/j.jtbi.2021.110936", themes: ['organells'], category: 'data', authors: 'Leech V, Hazel JW, Gatlin JC, Lindsay AE, Manhart A', thumbnail: 'publications/leech_nuclear_scaling_paper_thumb.png', pdfUrl: 'publications/leech_nuclear_scaling_paper.pdf' },
  { year: 2021, title: "Kinetic modelling of colonies of myxobacteria", journal: "Kinetic & Related Models", doi: "10.3934/krm.2020046", themes: ['collective','myxobacteria'], category: 'theorem', authors: 'Hittmeir S, Kanzler L, Manhart A, Schmeiser C', thumbnail: 'publications/kinetic_myxobacteria_thumb.png', pdfUrl: null },
  { year: 2020, title: "Large-Scale Dynamics of Self-propelled Particles Moving Through Obstacles: Model Derivation and Pattern Formation", journal: "Bulletin of Mathematical Biology", doi: "10.1007/s11538-020-00805-z", themes: ['collective'], category: 'theorem', authors: 'Aceves-Sanchez P, Degond P, Keaveny EE, Manhart A, Merino-Aceituno S, Peurichard D', thumbnail: 'publications/swimmer_obstacle_thumb.png', pdfUrl: 'publications/swimmer_obstacle.pdf' },
  { year: 2020, title: "Reverse-engineering forces responsible for dynamic clustering and spreading of multiple nuclei in developing muscle cells", journal: "Molecular Biology of the Cell", doi: "10.1091/mbc.e19-12-0711", themes: ['organells','cytoskeleton'], category: 'data', authors: 'Manhart A, Azevedo M, Baylies MK, Mogilner A', thumbnail: 'publications/reverse_engineer_thumb.png', pdfUrl: 'publications/reverse_engineer.pdf' },
  { year: 2020, title: "Centering and symmetry breaking in confined contracting actomyosin networks", journal: "eLife", doi: "10.7554/elife.55368", themes: ['cytoskeleton'], category: 'data', authors: 'Ierushalmi N, Malik-Garbi M, Manhart A, Shah EA, Goode BL, Mogilner A, Keren K', thumbnail: 'publications/centering_symmetry_actomyosin_thumb.png', pdfUrl: 'publications/centering_symmetry_actin.pdf' },
  { year: 2019, title: "Analyzing collective motion with machine learning and topology", journal: "Chaos", doi: "10.1063/1.5125493", themes: ['collective'], category: 'theorem', authors: 'Bhaskar D, Manhart A, Milzman J, Nardini JT, Storey KM, Topaz CM, Ziegelmeier L', thumbnail: 'publications/tda_thumb.png', pdfUrl: 'publications/tda.pdf' },
  { year: 2019, title: "Nuclear Scaling Is Coordinated among Individual Nuclei in Multinucleated Muscle Fibers", journal: "Developmental Cell", doi: "10.1016/j.devcel.2019.02.020", themes: ['organells','cytoskeleton'], category: 'data', authors: 'Windner SE, Manhart A, Brown A, Mogilner A, Baylies MK', thumbnail: 'publications/scaling_myonuclei_thumb.png', pdfUrl: 'publications/scaling_myonuclei.pdf' },
  { year: 2019, title: "Quantitative regulation of the dynamic steady state of actin networks", journal: "eLife", doi: "10.7554/elife.42413", themes: ['cytoskeleton'], category: 'data', authors: 'Manhart A, Icheva TA, Guerin C, Klar T, Boujemaa-Paterski R, Thery M, Blanchoin L, Mogilner A', thumbnail: 'publications/quantitative_actin_thumb.png', pdfUrl: 'publications/quantitative_actin.pdf' },
  { year: 2018, title: "Counter-propagating wave patterns in a swarm model with memory", journal: "Journal of Mathematical Biology", doi: "10.1007/s00285-018-1287-x", themes: ['collective','myxobacteria'], category: 'theorem', authors: 'Manhart A', thumbnail: 'publications/swarm_model_thumb.png', pdfUrl: 'publications/swarm_model_memory.pdf' },
  { year: 2018, title: "An age-structured continuum model for myxobacteria", journal: "Mathematical Models and Methods in Applied Sciences", doi: "10.1142/s0218202518400043", themes: ['collective','myxobacteria'], category: 'theorem', authors: 'Degond P, Manhart A, Yu H', thumbnail: 'publications/age_structured_myxobacteria.png', pdfUrl: 'publications/age_structured_myxobacteria.pdf' },
  { year: 2018, title: "Mechanical positioning of multiple nuclei in muscle cells", journal: "PLoS Computational Biology", doi: "10.1371/journal.pcbi.1006208", themes: ['organells','cytoskeleton'], category: 'data', authors: 'Manhart A, Windner S, Baylies M, Mogilner A', thumbnail: 'publications/mechanical_positioning_thumb.png', pdfUrl: 'publications/mechanical_positioning_myonuclei.pdf' },
  { year: 2018, title: "Intracellular Fluid Mechanics: Coupling Cytoplasmic Flow with Active Cytoskeletal Gel", journal: "Annual Review of Fluid Mechanics", doi: "10.1146/annurev-fluid-010816-060238", themes: ['cytoskeleton'], category: 'data', authors: 'Mogilner A, Manhart A', thumbnail: 'publications/annurev_fluid.png', pdfUrl: 'publications/annurev_fluid.pdf' },
  { year: 2018, title: "A Retrospective Assessment of Four Antigen Assays for the Detection of Invasive Candidiasis Among High-Risk Hospitalized Patients", journal: "Mycopathologia", doi: "10.1007/s11046-017-0238-1", themes: ['other'], category: 'data', authors: 'Hartl B, Zeller I, Manhart A, Selitsch B, Lass-Floerl C, Willinger B', thumbnail: null, pdfUrl: 'publications/antigen_assay_candidiasis.pdf' },
  { year: 2017, title: "A continuum model for nematic alignment of self-propelled particles", journal: "Discrete & Continuous Dynamical Systems - B", doi: "10.3934/dcdsb.2017063", themes: ['collective','myxobacteria'], category: 'theorem', authors: 'Degond P, Manhart A, Yu H', thumbnail: 'publications/continuum_nematic_thumb.png', pdfUrl: 'publications/continuum_nematic.pdf' },
  { year: 2017, title: "Numerical Treatment of the Filament Based Lamellipodium Model", journal: "Modelling Cellular Systems", doi: "10.1007/978-3-319-45833-5", themes: ['cytoskeleton'], category: 'theorem', authors: 'Manhart A, Oelz D, Schmeiser C, Sfakianakis N', thumbnail: 'publications/numerical_FBLM_thumb.png', pdfUrl: 'publications/numerical_FBLM.pdf' },
  { year: 2016, title: "Agent-based modeling: case study in cleavage furrow models", journal: "Molecular Biology of the Cell", doi: "10.1091/mbc.E16-01-0013", themes: ['collective','organells'], category: 'data', authors: 'Manhart A, Mogilner A', thumbnail: 'publications/agent_based_furrow_thumb.png', pdfUrl: 'publications/agent_based_cleavage_furrow.pdf' },
  { year: 2017, title: "Existence of and decay to equilibrium of the filament end density along the leading edge of the lamellipodium", journal: "Journal of Mathematical Biology", doi: "10.1007/s00285-016-1027-z", themes: ['cytoskeleton'], category: 'theorem', authors: 'Manhart A, Schmeiser C', thumbnail: 'publications/existence_leading_edge_thumb.png', pdfUrl: 'publications/existence_leading_edge.pdf' },
  { year: 2017, title: "Mathematical modeling of Myosin induced bistability of Lamellipodial fragments", journal: "Journal of Mathematical Biology", doi: "10.1007/s00285-016-1008-2", themes: ['cytoskeleton'], category: 'theorem', authors: 'Hirsch S, Manhart A, Schmeiser C', thumbnail: 'publications/myosin_bistability_thumb.png', pdfUrl: 'publications/modelling_myosin_bistability.pdf' },
  { year: 2015, title: "An extended Filament Based Lamellipodium Model produces various moving cell shapes in the presence of chemotactic signals", journal: "Journal of Theoretical Biology", doi: "10.1016/j.jtbi.2015.06.044", themes: ['cytoskeleton'], category: 'theorem', authors: 'Manhart A, Oelz D, Schmeiser C, Sfakianakis N', thumbnail: 'publications/extended_FBLM_shapes_thumb.png', pdfUrl: 'publications/extended_FBLM_shapes.pdf' },
  { year: 2014, title: "Large-scale mitochondrial DNA analysis in Southeast Asia reveals evolutionary effects of cultural isolation in the multi-ethnic population of Myanmar", journal: "BMC Evolutionary Biology", doi: "10.1186/1471-2148-14-17", themes: ['other'], category: 'data', authors: 'Summerer M, Horst J, Erhart G, Weissensteiner H, Schoenherr S, Pacher D, Forer L, Horst D, Manhart A, Horst B, Sanguansermsri T, Kloss-Brandstaetter A', thumbnail: 'publications/mtDNA_myanmar_thumb.png', pdfUrl: 'publications/mtDNA_myanmar.pdf' }
];

var BOOK_ICON_SVG = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>';

// ── D3 FORCE GRAPH ─────────────────────────────────────────────────────────
var svg = d3.select('#research-map');
var tooltip = document.getElementById('tooltip');
var container = document.getElementById('map-container');
var THEME_SIZE = 160;
var PUB_SIZE = 20;
var isDragging = false;
var activeThemeId = null;
var closeTimeout = null;

function draw() {
  svg.selectAll('*').remove();
  var W = container.clientWidth;
  var H = container.clientHeight;
  svg.attr('viewBox', '0 0 ' + W + ' ' + H);

  var g = svg.append('g');

  // Zoom (store zoom behavior so we can programmatically transform)
  var zoomBehavior = d3.zoom().scaleExtent([0.3, 3]).on('zoom', function(e) { g.attr('transform', e.transform); });
  svg.call(zoomBehavior);

  // Assign initial positions for themes in a circle to reduce edge crossings
  // Order chosen so related themes are adjacent
  var themeOrder = ['collective', 'myxobacteria', 'other', 'organells', 'cytoskeleton', 'mohecce'];
  var nodes = [
    ...themes.map(function(t) {
      var idx = themeOrder.indexOf(t.id);
      var angle = (idx / themeOrder.length) * 2 * Math.PI - Math.PI / 2;
      var rx = W * 0.18, ry = H * 0.18;
      return Object.assign({}, t, {
        type: 'theme',
        r: THEME_SIZE / 2 + 5,
        x: W / 2 + rx * Math.cos(angle),
        y: H / 2 + ry * Math.sin(angle)
      });
    }),
    ...publications.map(function(p, i) {
      // Place pubs near their primary theme
      var primaryTheme = p.themes[0];
      var idx = themeOrder.indexOf(primaryTheme);
      var angle = (idx / themeOrder.length) * 2 * Math.PI - Math.PI / 2;
      var spread = (Math.random() - 0.5) * 0.6;
      var dist = W * 0.08 + Math.random() * W * 0.06;
      return Object.assign({}, p, {
        type: 'pub',
        id: 'pub_' + i,
        r: 14,
        x: W / 2 + (W * 0.18 + dist) * Math.cos(angle + spread),
        y: H / 2 + (H * 0.18 + dist) * Math.sin(angle + spread)
      });
    })
  ];

  // Links
  var links = [];
  publications.forEach(function(pub, i) {
    pub.themes.forEach(function(tid) {
      links.push({ source: 'pub_' + i, target: tid });
    });
  });

  var simulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(links).id(function(d) { return d.id; }).distance(120).strength(0.7))
    .force('charge', d3.forceManyBody().strength(function(d) { return d.type === 'theme' ? -400 : -25; }))
    .force('center', d3.forceCenter(W / 2, H / 2))
    .force('collision', d3.forceCollide(function(d) { return d.type === 'theme' ? 88 : 14; }))
    .force('x', d3.forceX(W / 2).strength(0.04))
    .force('y', d3.forceY(H / 2).strength(0.04));

  // Links
  var link = g.append('g')
    .selectAll('line')
    .data(links)
    .join('line')
    .attr('class', 'map-link')
    .attr('stroke', function(d) {
      var tid = typeof d.target === 'object' ? d.target.id : d.target;
      var theme = themes.find(function(t) { return t.id === tid; });
      return theme ? theme.color : '#c8dde8';
    });

  // Publication nodes
  var pubNodeG = g.append('g')
    .selectAll('g')
    .data(nodes.filter(function(d) { return d.type === 'pub'; }))
    .join('g')
    .attr('class', 'pub-node-g')
    .call(d3.drag()
      .on('start', function(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
      .on('drag', function(e, d) { d.fx = e.x; d.fy = e.y; })
      .on('end', function(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
    )
    .each(function(d) {
      var el = this;
      var startX, startY;
      el.addEventListener('pointerdown', function(ev) {
        startX = ev.clientX; startY = ev.clientY;
      }, true);
      el.addEventListener('pointerup', function(ev) {
        var dx = ev.clientX - startX, dy = ev.clientY - startY;
        if (dx * dx + dy * dy < 36) {
          ev.stopPropagation();
          tooltip.style.opacity = 0;
          showPubModal(d);
        }
      }, true);
    });

  pubNodeG.append('rect')
    .attr('class', 'pub-sq')
    .attr('width', PUB_SIZE).attr('height', PUB_SIZE)
    .attr('x', -PUB_SIZE / 2).attr('y', -PUB_SIZE / 2)
    .attr('rx', 3)
    .attr('fill', function(d) {
      if (d.category === 'theorem') return '#fecaca';
      if (d.category === 'data') return '#a7f3d0';
      return '#e5e7eb';
    })
    .attr('stroke', function(d) {
      if (d.category === 'theorem') return '#c62828';
      if (d.category === 'data') return '#059669';
      return '#6b7280';
    })
    .attr('stroke-width', 2)
    .style('cursor', 'pointer');

  // Pub hover
  pubNodeG
    .on('mouseover', function(event, d) {
      tooltip.innerHTML = '<div class="tt-name">' + d.title + '</div><div class="tt-meta">' + d.year + ' \u00B7 ' + d.journal + '</div>';
      tooltip.style.opacity = 1;
    })
    .on('mousemove', function(event) {
      tooltip.style.left = (event.clientX + 14) + 'px';
      tooltip.style.top = (event.clientY - 10) + 'px';
    })
    .on('mouseleave', function() {
      tooltip.style.opacity = 0;
    });

  // Theme nodes
  var themeNodeG = g.append('g')
    .selectAll('g')
    .data(nodes.filter(function(d) { return d.type === 'theme'; }))
    .join('g')
    .attr('class', 'theme-node-g')
    .call(d3.drag()
      .on('start', function(e, d) { isDragging = false; if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
      .on('drag', function(e, d) { isDragging = true; d.fx = e.x; d.fy = e.y; })
      .on('end', function(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
    );

  // foreignObject is oversized (+40px each side) so box-shadow/active glow isn't clipped
  var FO_PAD = 40;
  var FO_SIZE = THEME_SIZE + FO_PAD * 2;
  themeNodeG.append('foreignObject')
    .attr('class', 'theme-fo')
    .attr('width', FO_SIZE)
    .attr('height', FO_SIZE)
    .attr('x', -FO_SIZE / 2)
    .attr('y', -FO_SIZE / 2)
    .append('xhtml:div')
    .attr('class', 'theme-fo-inner')
    .attr('xmlns', 'http://www.w3.org/1999/xhtml')
    .append('div')
    .attr('class', 'hub-card-node')
    .each(function(d) {
      var self = this;
      self.style.borderColor = d.color;
      self.innerHTML =
        '<div class="hub-image-node"><img src="' + d.thumb + '" alt="' + d.name + '"></div>' +
        '<h3>' + d.name + '</h3>' +
        '<p>' + d.subtitle + '</p>';
      // Track pointerdown position to distinguish click from drag
      var downX, downY;
      self.addEventListener('pointerdown', function(event) {
        downX = event.clientX;
        downY = event.clientY;
      });
      self.addEventListener('click', function(event) {
        // Only treat as click if pointer didn't move more than 5px
        var dx = event.clientX - downX, dy = event.clientY - downY;
        if (dx * dx + dy * dy > 25) return;
        event.stopPropagation();
        showThemeDetail(d);
      });
    });

  // Tick
  simulation.on('tick', function() {
    nodes.forEach(function(d) {
      var pad = d.type === 'theme' ? THEME_SIZE / 2 + 10 : PUB_SIZE / 2 + 5;
      d.x = Math.max(pad, Math.min(W - pad, d.x));
      d.y = Math.max(pad, Math.min(H - pad, d.y));
    });
    link
      .attr('x1', function(d) { return d.source.x; }).attr('y1', function(d) { return d.source.y; })
      .attr('x2', function(d) { return d.target.x; }).attr('y2', function(d) { return d.target.y; });
    pubNodeG.attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
    themeNodeG.attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
  });

  // Pre-settle with extra iterations for a well-converged layout
  g.style('opacity', 0);
  for (var i = 0; i < 500; i++) simulation.tick();
  g.transition().duration(800).style('opacity', 1);
  simulation.alpha(0.15).restart();

  // Click on empty SVG area to close panels
  // Add an invisible background rect that captures clicks on empty space
  g.insert('rect', ':first-child')
    .attr('width', W * 3).attr('height', H * 3)
    .attr('x', -W).attr('y', -H)
    .attr('fill', 'transparent')
    .style('cursor', 'default')
    .on('click', function(event) {
      closeThemeDetail();
      closePubModal();
    });

  // Store references for external functions
  window._mapRefs = { g: g, link: link, pubNodeG: pubNodeG, themeNodeG: themeNodeG, W: W, H: H, nodes: nodes, links: links, svg: svg, zoomBehavior: zoomBehavior };
}

// ── THEME DETAIL ──────────────────────────────────────────────────────────
function showThemeDetail(theme) {
  var refs = window._mapRefs;
  if (!refs) return;
  activeThemeId = theme.id;

  // Zoom to center theme using D3 zoom transform (stays in sync with zoom behavior)
  var scale = 1.3;
  var tx = refs.W / 2 - theme.x * scale;
  var ty = refs.H / 2 - theme.y * scale;
  var newTransform = d3.zoomIdentity.translate(tx, ty).scale(scale);
  refs.svg.transition().duration(700).ease(d3.easeCubicInOut).call(refs.zoomBehavior.transform, newTransform);

  // Highlight connected links
  var connectedPubIds = refs.links
    .filter(function(l) {
      var sid = typeof l.source === 'object' ? l.source.id : l.source;
      var tid = typeof l.target === 'object' ? l.target.id : l.target;
      return sid === theme.id || tid === theme.id;
    })
    .map(function(l) {
      var sid = typeof l.source === 'object' ? l.source.id : l.source;
      var tid = typeof l.target === 'object' ? l.target.id : l.target;
      return sid === theme.id ? tid : sid;
    });

  refs.link.classed('highlighted', function(l) {
    var tid = typeof l.target === 'object' ? l.target.id : l.target;
    var sid = typeof l.source === 'object' ? l.source.id : l.source;
    return tid === theme.id || sid === theme.id;
  });
  refs.link.classed('dimmed', function(l) {
    var tid = typeof l.target === 'object' ? l.target.id : l.target;
    var sid = typeof l.source === 'object' ? l.source.id : l.source;
    return tid !== theme.id && sid !== theme.id;
  });

  refs.pubNodeG.classed('dimmed', function(d) { return connectedPubIds.indexOf(d.id) === -1; });
  refs.themeNodeG.classed('dimmed', function(d) { return d.id !== theme.id; });

  // Active state on hub-card
  refs.themeNodeG.selectAll('.hub-card-node').classed('active', function(d) { return d.id === theme.id; });

  // Populate panel
  var panel = document.getElementById('theme-detail-panel');
  var iconEl = document.getElementById('detailIcon');
  iconEl.style.borderColor = theme.color;
  iconEl.innerHTML = '<img src="' + theme.thumb + '" alt="' + theme.name + '" style="width:100%;height:100%;object-fit:cover;">';

  document.getElementById('detailTitle').textContent = theme.name;
  document.getElementById('detailSubtitle').textContent = theme.subtitle;
  var descEl = document.getElementById('detailDesc');
  if (theme.richDescription) {
    descEl.innerHTML = theme.richDescription;
  } else {
    descEl.textContent = theme.description;
  }

  var themePubs = publications.filter(function(p) { return p.themes.indexOf(theme.id) !== -1; });
  themePubs.sort(function(a, b) { return b.year - a.year; });
  document.getElementById('detailPubCount').textContent = 'Publications (' + themePubs.length + ')';

  document.getElementById('detailPubList').innerHTML = themePubs.map(function(p) {
    return renderPubItem(p);
  }).join('');

  // Cancel any pending close timeout so it doesn't kill this open
  if (closeTimeout) { clearTimeout(closeTimeout); closeTimeout = null; }

  panel.classList.add('open');
  panel.style.opacity = '1';
  panel.style.maxHeight = panel.scrollHeight + 2000 + 'px';

  setTimeout(function() {
    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 200);
}

function closeThemeDetail() {
  activeThemeId = null;
  var refs = window._mapRefs;
  if (refs) {
    refs.svg.transition().duration(500).ease(d3.easeCubicInOut).call(refs.zoomBehavior.transform, d3.zoomIdentity);
    refs.link.classed('highlighted', false).classed('dimmed', false);
    refs.pubNodeG.classed('dimmed', false);
    refs.themeNodeG.classed('dimmed', false);
    refs.themeNodeG.selectAll('.hub-card-node').classed('active', false);
  }
  var panel = document.getElementById('theme-detail-panel');
  panel.style.maxHeight = '0';
  panel.style.opacity = '0';
  if (closeTimeout) clearTimeout(closeTimeout);
  closeTimeout = setTimeout(function() { panel.classList.remove('open'); closeTimeout = null; }, 500);
}

// ── PUB MODAL ─────────────────────────────────────────────────────────────
function showPubModal(pub) {
  document.getElementById('pubModalContent').innerHTML = renderPubItem(pub);
  document.getElementById('pubModalOverlay').classList.add('open');
}

function closePubModal() {
  document.getElementById('pubModalOverlay').classList.remove('open');
}

document.getElementById('pubModalOverlay').addEventListener('click', function(e) {
  if (e.target === e.currentTarget) closePubModal();
});
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') { closePubModal(); closeThemeDetail(); }
});

// ── RENDER PUB ITEM ───────────────────────────────────────────────────────
function renderPubItem(p) {
  var tagClass = p.category === 'theorem' ? 'pub-tag-theorem' : (p.category === 'data' ? 'pub-tag-data' : 'pub-tag-other');
  var tagLabel = p.category === 'theorem' ? 'Contains proofs' : (p.category === 'data' ? 'Contains data' : 'Other');
  var thumbHtml = p.thumbnail
    ? '<img src="' + p.thumbnail + '" alt="thumbnail"/>'
    : BOOK_ICON_SVG;
  var linksHtml = '';
  if (p.pdfUrl) linksHtml += '<a class="pub-link" href="' + p.pdfUrl + '" target="_blank">PDF</a>';
  if (p.doi) linksHtml += '<a class="pub-link" href="https://doi.org/' + p.doi + '" target="_blank">DOI</a>';

  return '<div class="pub-item">' +
    '<div class="pub-thumb">' + thumbHtml + '</div>' +
    '<div>' +
      '<div class="pub-title-row"><p class="pub-title">' + p.title + '</p><span class="pub-tag ' + tagClass + '">' + tagLabel + '</span></div>' +
      '<p class="pub-meta">' + p.authors + ' &middot; <strong>' + p.journal + '</strong></p>' +
      (linksHtml ? '<div class="pub-links">' + linksHtml + '</div>' : '') +
    '</div>' +
    '<span class="pub-year">' + p.year + '</span>' +
  '</div>';
}

// ── INIT ──────────────────────────────────────────────────────────────────
draw();
window.addEventListener('resize', function() {
  closeThemeDetail();
  closePubModal();
  draw();
});
</script>
</body>
</html>
